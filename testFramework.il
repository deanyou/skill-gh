;; copyleft ebecheto
;; testFramework.il - SKILLè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶
;; ä¸ºSKILL-GHåº“æä¾›ç°ä»£åŒ–çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•èƒ½åŠ›

; å…¨å±€æµ‹è¯•é…ç½®
global(skillTestConfig)
skillTestConfig = list(
  'reportFormat "html"           ; "html", "text", "json"
  'outputDir "/tmp/skill_tests"
  'timeout 30000                 ; æµ‹è¯•è¶…æ—¶æ—¶é—´(æ¯«ç§’)
  'parallelExecution t           ; å¹¶è¡Œæ‰§è¡Œæµ‹è¯•
  'colorOutput t                 ; å½©è‰²è¾“å‡º
  'verbose nil                   ; è¯¦ç»†æ¨¡å¼
  'coverage t                    ; ä»£ç è¦†ç›–ç‡ç»Ÿè®¡
)

; æµ‹è¯•å¥—ä»¶æ•°æ®ç»“æ„
defun(createTestSuite(suiteName @optional description)
  let((suite))
    suite = list(
      'name suiteName
      'description or(description "")
      'tests nil
      'setUp nil
      'tearDown nil
      'beforeEach nil
      'afterEach nil
      'stats list(
        'total 0
        'passed 0 
        'failed 0
        'skipped 0
        'errors 0
        'duration 0
      )
      'results nil
      'startTime nil
      'endTime nil
    )
    suite
  )
)

; æ·»åŠ æµ‹è¯•ç”¨ä¾‹
defun(addTest(suite testName testFunc @optional description category)
  let((test newTests))
    test = list(
      'name testName
      'description or(description "")
      'category or(category "default")
      'func testFunc
      'status "pending"
      'result nil
      'duration 0
      'error nil
      'assertions nil
    )
    
    newTests = append(getf(suite 'tests) list(test))
    putf(suite 'tests newTests)
    
    ; æ›´æ–°ç»Ÿè®¡
    putf(suite 'stats 
      putf(getf(suite 'stats) 'total (length(newTests))))
    
    suite
  )
)

; æ–­è¨€å‡½æ•°åº“
defun(assertTrue(condition @optional message)
  let((assertion))
    assertion = list(
      'type "assertTrue"
      'condition condition
      'expected t
      'actual condition
      'passed condition
      'message or(message sprintf(nil "Expected true, got %L" condition))
    )
    
    recordAssertion(assertion)
    
    unless(condition
      error(sprintf(nil "Assertion failed: %s" getf(assertion 'message)))
    )
    
    condition
  )
)

defun(assertEqual(expected actual @optional message)
  let((assertion passed))
    passed = equal(expected actual)
    assertion = list(
      'type "assertEqual"
      'expected expected
      'actual actual
      'passed passed
      'message or(message 
        sprintf(nil "Expected %L, got %L" expected actual))
    )
    
    recordAssertion(assertion)
    
    unless(passed
      error(sprintf(nil "Assertion failed: %s" getf(assertion 'message)))
    )
    
    passed
  )
)

defun(assertNotEqual(notExpected actual @optional message)
  let((assertion passed))
    passed = not(equal(notExpected actual))
    assertion = list(
      'type "assertNotEqual"
      'notExpected notExpected
      'actual actual
      'passed passed
      'message or(message 
        sprintf(nil "Expected not %L, but got %L" notExpected actual))
    )
    
    recordAssertion(assertion)
    
    unless(passed
      error(sprintf(nil "Assertion failed: %s" getf(assertion 'message)))
    )
    
    passed
  )
)

defun(assertType(expected actual @optional message)
  let((actualType assertion passed))
    actualType = type(actual)
    passed = eq(expected actualType)
    assertion = list(
      'type "assertType"
      'expected expected
      'actual actualType
      'value actual
      'passed passed
      'message or(message 
        sprintf(nil "Expected type %s, got %s for value %L" 
          expected actualType actual))
    )
    
    recordAssertion(assertion)
    
    unless(passed
      error(sprintf(nil "Assertion failed: %s" getf(assertion 'message)))
    )
    
    passed
  )
)

defun(assertThrows(func args @optional expectedErrorPattern message)
  let((assertion threw errorMsg passed))
    threw = nil
    errorMsg = nil
    
    errset(
      apply(func args)
      ; å¦‚æœæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œthrewä¿æŒnil
    )
    
    ; æ£€æŸ¥æ˜¯å¦æŠ›å‡ºäº†å¼‚å¸¸
    threw = t  ; errsetè¿”å›nilè¡¨ç¤ºæœ‰å¼‚å¸¸
    
    passed = threw
    when(and(threw expectedErrorPattern)
      ; å¦‚æœæŒ‡å®šäº†é”™è¯¯æ¨¡å¼ï¼Œæ£€æŸ¥é”™è¯¯ä¿¡æ¯æ˜¯å¦åŒ¹é…
      passed = and(threw rexMatchp(expectedErrorPattern errorMsg))
    )
    
    assertion = list(
      'type "assertThrows"
      'func func
      'args args
      'expectedPattern expectedErrorPattern
      'threw threw
      'errorMsg errorMsg
      'passed passed
      'message or(message 
        sprintf(nil "Expected function to throw error%s" 
          if(expectedErrorPattern 
            sprintf(nil " matching '%s'" expectedErrorPattern) "")))
    )
    
    recordAssertion(assertion)
    
    unless(passed
      error(sprintf(nil "Assertion failed: %s" getf(assertion 'message)))
    )
    
    passed
  )
)

; è®°å½•æ–­è¨€ç»“æœï¼ˆå…¨å±€å˜é‡ï¼Œä¾›æµ‹è¯•è¿è¡Œå™¨ä½¿ç”¨ï¼‰
global(currentTestAssertions)
currentTestAssertions = nil

defun(recordAssertion(assertion)
  currentTestAssertions = append(currentTestAssertions list(assertion))
)

; æ‰§è¡Œå•ä¸ªæµ‹è¯•
defun(runSingleTest(suite test)
  let((startTime endTime result error))
    ; æ¸…ç©ºæ–­è¨€è®°å½•
    currentTestAssertions = nil
    
    startTime = getCurrentTimestamp()
    
    ; æ‰§è¡ŒbeforeEaché’©å­
    when(getf(suite 'beforeEach)
      apply(getf(suite 'beforeEach) nil)
    )
    
    ; æ‰§è¡Œæµ‹è¯•
    errset(
      result = apply(getf(test 'func) nil)
      
      ; æµ‹è¯•æˆåŠŸå®Œæˆ
      putf(test 'status "passed")
      putf(test 'result result)
    )
    
    ; å¦‚æœerrsetè¿”å›nilï¼Œè¯´æ˜æœ‰å¼‚å¸¸
    when(null(result)
      putf(test 'status "failed")
      putf(test 'error "Test function threw an exception")
    )
    
    ; æ‰§è¡ŒafterEaché’©å­  
    when(getf(suite 'afterEach)
      errset(
        apply(getf(suite 'afterEach) nil)
      )
    )
    
    endTime = getCurrentTimestamp()
    putf(test 'duration (endTime - startTime))
    putf(test 'assertions currentTestAssertions)
    
    test
  )
)

; æ‰§è¡Œæµ‹è¯•å¥—ä»¶
defun(runTestSuite(suite @optional options)
  let((tests results stats startTime endTime))
    startTime = getCurrentTimestamp()
    putf(suite 'startTime startTime)
    
    printf("ğŸ§ª Running test suite: %s\n" getf(suite 'name))
    when(getf(suite 'description) 
      printf("   %s\n" getf(suite 'description)))
    
    tests = getf(suite 'tests)
    
    ; æ‰§è¡ŒsetUpé’©å­
    when(getf(suite 'setUp)
      printf("ğŸ”§ Setting up test suite...\n")
      apply(getf(suite 'setUp) nil)
    )
    
    ; æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    results = foreach(mapcar test tests
      printf("  â€¢ Running: %s... " getf(test 'name))
      
      runSingleTest(suite test)
      
      case(getf(test 'status)
        ("passed" printf("âœ… PASS (%.2fms)\n" getf(test 'duration)))
        ("failed" printf("âŒ FAIL (%.2fms)\n" getf(test 'duration)))
        ("skipped" printf("â­ï¸ SKIP\n"))
        (t printf("â“ UNKNOWN\n"))
      )
      
      test
    )
    
    ; æ‰§è¡ŒtearDowné’©å­
    when(getf(suite 'tearDown)
      printf("ğŸ§¹ Tearing down test suite...\n")
      apply(getf(suite 'tearDown) nil)
    )
    
    endTime = getCurrentTimestamp()
    putf(suite 'endTime endTime)
    putf(suite 'results results)
    
    ; æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    stats = calculateTestStats(results)
    putf(suite 'stats stats)
    
    ; æ‰“å°æ‘˜è¦
    printTestSummary(suite)
    
    ; ç”ŸæˆæŠ¥å‘Š
    when(getf(skillTestConfig 'reportFormat)
      generateTestReport(suite)
    )
    
    suite
  )
)

; è®¡ç®—æµ‹è¯•ç»Ÿè®¡
defun(calculateTestStats(tests)
  let((stats total passed failed skipped errors duration))
    total = length(tests)
    passed = length(setof(t tests eq(getf(t 'status) "passed")))
    failed = length(setof(t tests eq(getf(t 'status) "failed")))  
    skipped = length(setof(t tests eq(getf(t 'status) "skipped")))
    errors = length(setof(t tests getf(t 'error)))
    duration = apply('plus foreach(mapcar t tests getf(t 'duration)))
    
    list(
      'total total
      'passed passed
      'failed failed
      'skipped skipped  
      'errors errors
      'duration duration
      'passRate if(total > 0 (passed * 100.0 / total) 0.0)
    )
  )
)

; æ‰“å°æµ‹è¯•æ‘˜è¦
defun(printTestSummary(suite)
  let((stats))
    stats = getf(suite 'stats)
    
    printf("\nğŸ“Š Test Results Summary:\n")
    printf("   Total: %d\n" getf(stats 'total))
    printf("   âœ… Passed: %d\n" getf(stats 'passed))  
    printf("   âŒ Failed: %d\n" getf(stats 'failed))
    printf("   â­ï¸ Skipped: %d\n" getf(stats 'skipped))
    printf("   â±ï¸ Duration: %.2fms\n" getf(stats 'duration))
    printf("   ğŸ“ˆ Pass Rate: %.1f%%\n" getf(stats 'passRate))
  )
)

; ç”ŸæˆHTMLæµ‹è¯•æŠ¥å‘Š
defun(generateTestReport(suite)
  let((reportPath fp))
    reportPath = sprintf(nil "%s/%s_report.html" 
      getf(skillTestConfig 'outputDir) getf(suite 'name))
    
    ; ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    system(sprintf(nil "mkdir -p %s" getf(skillTestConfig 'outputDir)))
    
    fp = outfile(reportPath)
    when(fp
      fprintf(fp "<!DOCTYPE html>\n<html>\n<head>\n")
      fprintf(fp "<title>Test Report: %s</title>\n" getf(suite 'name))
      fprintf(fp "<style>%s</style>\n" getTestReportCSS())
      fprintf(fp "</head>\n<body>\n")
      
      ; ç”ŸæˆæŠ¥å‘Šå†…å®¹
      generateHTMLReportContent(fp suite)
      
      fprintf(fp "</body>\n</html>\n")
      close(fp)
      
      printf("ğŸ“„ Test report generated: %s\n" reportPath)
    )
  )
)

; è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
defun(getCurrentTimestamp()
  ; ç®€åŒ–å®ç°ï¼Œå®é™…åº”ä½¿ç”¨ç³»ç»Ÿæ—¶é—´å‡½æ•°
  let((timeStr))
    timeStr = system("date +%s%3N")  ; Unix timestamp with milliseconds
    atoi(rexReplace(timeStr "\n" "" 0))
  )
)

; CSSæ ·å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
defun(getTestReportCSS()
  "body { font-family: Arial, sans-serif; margin: 20px; }
   .header { background: #f5f5f5; padding: 15px; border-radius: 5px; }
   .stats { display: flex; gap: 20px; margin: 20px 0; }
   .stat { padding: 10px; border-radius: 5px; text-align: center; }
   .passed { background: #d4edda; color: #155724; }
   .failed { background: #f8d7da; color: #721c24; }
   .test-item { margin: 10px 0; padding: 10px; border-left: 4px solid #ccc; }
   .test-passed { border-left-color: #28a745; }
   .test-failed { border-left-color: #dc3545; }"
)

printf("testFramework.il loaded - SKILLè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶\n")
printf("ä½¿ç”¨ç¤ºä¾‹:\n")
printf("  suite = createTestSuite(\"MyTests\")\n")
printf("  addTest(suite \"testBBoxHeight\" lambda() assertTrue(bBoxHeight('((0 0) (10 5))) == 5))\n")
printf("  runTestSuite(suite)\n")